### MESSAGE SERVICE - EVENT-DRIVEN ARCHITECTURE TEST
### Flow: REST API â†’ Save to MongoDB â†’ Publish to Kafka â†’ Consume Event â†’ Broadcast via SignalR

@baseUrl = http://localhost:5005/api

### 1. Create Direct Conversation (Parent â†” Teacher)
POST {{baseUrl}}/conversations
Content-Type: application/json

{
  "type": "DirectMessage",
  "initiatorId": "parent-001",
  "initiatorType": "Parent",
  "memberIds": ["teacher-001"],
  "memberTypes": ["Teacher"]
}

### Extract conversation ID from response
### Example: "id": "674ae9e5f2e3b5c8d4f1a2b3"

### 2. Send Message via REST API (Event-Driven)
### âœ… REST API â†’ Save MongoDB â†’ Publish MessageSentEvent to Kafka â†’ SignalR Broadcast
POST {{baseUrl}}/conversations/674ae9e5f2e3b5c8d4f1a2b3/messages
Content-Type: application/json

{
  "senderId": "parent-001",
  "senderType": "Parent",
  "content": "Xin chÃ o tháº§y, con em há»c tháº¿ nÃ o áº¡?",
  "attachments": []
}

### 3. Send Another Message
POST {{baseUrl}}/conversations/674ae9e5f2e3b5c8d4f1a2b3/messages
Content-Type: application/json

{
  "senderId": "teacher-001",
  "senderType": "Teacher",
  "content": "Dáº¡ em há»c ráº¥t tá»‘t, chÄƒm chá»‰ láº¯m áº¡!",
  "attachments": []
}

### 4. Send Message with Attachments
POST {{baseUrl}}/conversations/674ae9e5f2e3b5c8d4f1a2b3/messages
Content-Type: application/json

{
  "senderId": "teacher-001",
  "senderType": "Teacher",
  "content": "ÄÃ¢y lÃ  bÃ i kiá»ƒm tra cá»§a em áº¡",
  "attachments": [
    {
      "fileName": "bai-kiem-tra.pdf",
      "fileUrl": "https://storage.example.com/files/test-results.pdf",
      "fileType": "application/pdf",
      "fileSize": 2048576
    }
  ]
}

### 5. Get Conversation Messages
GET {{baseUrl}}/conversations/674ae9e5f2e3b5c8d4f1a2b3/messages?page=1&pageSize=20

### 6. Get User's Conversations
GET {{baseUrl}}/conversations?userId=parent-001&userType=Parent&page=1&pageSize=20

### 7. Create Student Group Conversation (Auto-created via Event)
### Scenario: Khi StudentService assign student vÃ o class
### StudentService sáº½ publish StudentAssignedToClassEvent
### MessageService consume event vÃ  tá»± Ä‘á»™ng táº¡o student group

### Simulate event from StudentService:
### {
###   "studentId": "student-001",
###   "classId": "class-10a1",
###   "teacherIds": ["teacher-001", "teacher-002"],
###   "parentIds": ["parent-001", "parent-002"]
### }
### => MessageService tá»± Ä‘á»™ng táº¡o conversation StudentGroup

### 8. Test SignalR Connection (Use browser console or Postman)
### JavaScript client code:
###
### const connection = new signalR.HubConnectionBuilder()
###     .withUrl("http://localhost:5005/chathub")
###     .build();
###
### // Join conversation
### connection.invoke("JoinConversation", "674ae9e5f2e3b5c8d4f1a2b3");
###
### // Listen for new messages
### connection.on("ReceiveMessage", (message) => {
###     console.log("New message:", message);
### });
###
### // Start connection
### await connection.start();

### ARCHITECTURE FLOW EXPLANATION:
### 
### ğŸ“¤ SENDING MESSAGE (Event-Driven):
### 1. Client gá»­i POST request Ä‘áº¿n /api/conversations/{id}/messages
### 2. SendMessageCommandHandler xá»­ lÃ½:
###    - Validate input
###    - Save message to MongoDB
###    - Publish MessageSentEvent to Kafka topic "MessageSentEvent"
### 3. Kafka consumer (MessageSentEventHandler) nháº­n event:
###    - Láº¥y message data tá»« event
###    - Broadcast qua SignalR Ä‘áº¿n táº¥t cáº£ clients trong conversation group
### 4. Clients nháº­n message realtime qua SignalR
###
### âœ… BENEFITS:
### - Decoupling: API khÃ´ng cáº§n biáº¿t vá» SignalR
### - Reliability: Kafka Ä‘áº£m báº£o message khÃ´ng bá»‹ máº¥t
### - Scalability: CÃ³ thá»ƒ scale API vÃ  SignalR server riÃªng biá»‡t
### - Audit: CÃ³ thá»ƒ log táº¥t cáº£ events trong Kafka
### - Flexibility: CÃ³ thá»ƒ thÃªm nhiá»u consumers khÃ¡c (push notification, analytics, etc.)

